<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Report System - Bulk Pay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root{--report-blue:#3498db;--header-bg:#2c3e50;--history-bg:#ffffff}body{background-color:#f4f7f6;font-family:'Segoe UI',Tahoma,sans-serif}.sticky-top-container{position:sticky;top:0;z-index:1050;background-color:#f4f7f6;padding:10px 0}.table-container,.history-container{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.05);position:relative;overflow:hidden;margin-bottom:20px}.history-container{display:none;border:2px solid var(--report-blue);margin-top:10px}.table thead th{background-color:var(--header-bg)!important;color:#fff!important;font-size:.75rem;text-transform:uppercase;white-space:nowrap}.status-badge{font-size:.65rem;padding:4px 8px;border-radius:20px;font-weight:600;border:1px solid}.action-select{font-size:.75rem;padding:4px;border-radius:4px;border:1px solid #ddd}.paid-input{width:80px;font-size:.75rem;border:1px solid var(--report-blue);border-radius:4px;padding:3px}#historyLoader,#tableLoader{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.7);display:none;justify-content:center;align-items:center;z-index:100}.toast-msg{position:fixed;bottom:20px;right:20px;z-index:2000;display:none;padding:12px 24px;border-radius:8px;color:#fff;box-shadow:0 4px 15px rgba(0,0,0,.15);font-weight:600}.filter-section{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,.05)}.fade-content{transition:opacity .3s ease}.bulk-pay-btn{display:none}
    </style>
</head>
<body>

<div id="toast" class="toast-msg"></div>

<div class="container-fluid px-3">
    <!-- Header -->
    <div class="sticky-top-container">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h4 class="fw-bold m-0 text-dark">Business Report System</h4>
                <p class="text-muted small mb-0">ইনভয়েস পেমেন্ট এবং স্মার্ট বালক পেমেন্ট</p>
            </div>
            <div class="d-flex gap-2">
                <!-- Bulk Pay Button (Only shows when filtered) -->
                <button id="bulkPayBtn" class="btn btn-success btn-sm rounded-pill px-3 bulk-pay-btn" onclick="bulkPayFiltered()">
                    <i class="fas fa-check-double me-1"></i> ALL INVOICE PAID
                </button>
                <button id="historyBtn" class="btn btn-primary btn-sm rounded-pill px-3" onclick="toggleHistorySection()">
                    <i class="fas fa-history me-1"></i> Payment History
                </button>
                <button class="btn btn-dark btn-sm rounded-pill px-4" onclick="fetchRecentSales(true)">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Global Filter Section -->
       <div id="filterSection" class="filter-section fade-content mb-3">
    <div class="card p-3 shadow-sm border-0 bg-white">
        <div class="row g-2 mb-2">
            <div class="col-md-12">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="globalSearch" class="form-control border-start-0" placeholder="Search Here, Name, Invoice No, Mobile No, Code" onkeyup="applyMainFilters()">
                </div>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-md-3">
                <select id="statusFilter" class="form-select form-select-sm" onchange="applyMainFilters()">
                    <option value="">All Status</option>
                    <option value="UNPAID">Unpaid</option>
                    <option value="PART PAID">Part Paid</option>
                    <option value="FULL PAID">Full Paid</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light small">From</span>
                    <input type="date" id="startDate" class="form-control" onchange="applyMainFilters()">
                </div>
            </div>
            <div class="col-md-3">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light small">To</span>
                    <input type="date" id="endDate" class="form-control" onchange="applyMainFilters()">
                </div>
            </div>
            <div class="col-md-3">
                <button class="btn btn-sm btn-outline-danger w-100" onclick="resetMainFilters()">
                    <i class="fas fa-sync-alt me-1"></i> Reset All
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Summary Cards -->
        <div class="row g-2 mb-3 text-center fade-content" id="mainSummary">
            <div class="col-md-4">
                <div class="card p-2 border-0 shadow-sm">
                    <h6 class="text-muted small mb-1">মোট বিক্রয়</h6>
                    <h5 id="summaryTotalSales" class="fw-bold m-0 text-primary">0</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-2 border-0 shadow-sm">
                    <h6 class="text-muted small mb-1">মোট জমা</h6>
                    <h5 id="summaryTotalPaid" class="fw-bold m-0 text-success">0</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-2 border-0 shadow-sm">
                    <h6 class="text-muted small mb-1">মোট বকেয়া</h6>
                    <h5 id="summaryTotalDue" class="fw-bold m-0 text-danger">0</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History Section -->
    <div id="historySection" class="history-container">
        <div class="bg-dark text-white p-2 d-flex justify-content-between align-items-center">
            <span class="fw-bold small ms-2"><i class="fas fa-list me-2"></i>Payment History (Records)</span>
            <button class="btn btn-sm btn-danger py-0" onclick="toggleHistorySection()">Close <i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-2 bg-light border-bottom">
            <div class="row g-2">
                <div class="col-md-2">
                    <input type="date" id="histDate" class="form-control form-control-sm" onchange="filterHistory()">
                </div>
                <div class="col-md-2">
                    <input type="text" id="histCode" class="form-control form-control-sm" placeholder="Search Code..." onkeyup="filterHistory()">
                </div>
                <div class="col-md-2">
                    <input type="text" id="histArea" class="form-control form-control-sm" placeholder="Search Area..." onkeyup="filterHistory()">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-sm btn-outline-danger w-100" onclick="resetHistoryFilters()">Reset</button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-sm btn-success w-100 fw-bold" onclick="downloadCSV()">
                        <i class="fas fa-file-csv me-1"></i> CSV
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-sm btn-danger w-100 fw-bold" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </button>
                </div>
            </div>
        </div>

        <div class="position-relative">
            <div id="historyLoader"><div class="spinner-border text-primary"></div></div>
            <div class="table-responsive" style="max-height: 450px;">
    <table class="table table-sm table-hover mb-0" id="paymentHistoryTable">
    <thead class="sticky-top">
        <tr>
            <th>SL</th>
            <th>Payment Date/Time</th>
            <th>Inv No</th>
            <th>Inv Date</th> 
            <th>Cust. Code</th>
            <th>Customer Name</th>
            <th>Address</th> 
            <th>Area</th>
            <th class="text-end">Paid Amount</th>
            <th class="text-end">Due Left</th>
            <th class="text-center">Status</th>
        </tr>
    </thead>
    <tbody id="historyTableBody">
        <tr><td colspan="11" class="text-center py-4">লোড হচ্ছে...</td></tr>
    </tbody>
</table>
</div>
        </div>
    </div>

    <!-- Main Data Table -->
    <div id="mainTableContainer" class="table-container border fade-content">
        <div id="tableLoader">
            <div class="text-center">
                <div class="spinner-border text-primary mb-2"></div>
                <div id="loaderText" class="text-muted small fw-bold">লোড হচ্ছে...</div>
            </div>
        </div>
        <div class="table-responsive" style="max-height: 60vh;">
            <table class="table table-hover align-middle mb-0">
                <thead class="sticky-top">
                    <tr>
                        <th>Inv No</th>
                        <th>Date</th>
                        <th>Cust. Code</th>
                        <th>Customer Name</th>
                        <th>Mobile No</th>
                        <th>Area</th>
                        <th class="text-end">Total Amount</th>
                        <th class="text-end">Paid Amount</th>
                        <th class="text-end">Due Amount</th>
                        <th class="text-center">Status</th>
                        <th class="text-center" style="min-width: 150px;">Action</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <tr><td colspan="10" class="text-center py-5">ডাটা লোড হচ্ছে...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // গুরুত্বপূর্ণ: আপনার Google Apps Script Web App URL এখানে বসান
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkDCX5zax-NuoSKRSxJIjL9Rx4MbtVxvm5QlrOEIxrTR-s3sVuRHJy_ISNIm3ehDYs/exec";

    let rawSalesData = [];
    let currentFilteredData = [];
    let rawHistoryData = [];

    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        if(!t) return;
        t.innerText = msg;
        t.style.backgroundColor = isError ? '#e74c3c' : '#27ae60';
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 3000);
    }

    // --- ডাটা ফেচিং ফাংশন (গিটহাব ফ্রেন্ডলি) ---
    async function fetchRecentSales(showLoaderFlag = false) {
        if (showLoaderFlag) {
            document.getElementById('tableLoader').style.display = 'flex';
            document.getElementById('loaderText').innerText = "লোড হচ্ছে...";
        }

        try {
            const response = await fetch(`${WEB_APP_URL}?action=getSalesMasterData`);
            const data = await response.json();
            rawSalesData = (data && data.length > 1) ? data.slice(1) : [];
            applyMainFilters();
        } catch (err) {
            showToast("সার্ভার কানেকশন এরর!", true);
            console.error(err);
        } finally {
            document.getElementById('tableLoader').style.display = 'none';
        }
    }

    async function fetchAllHistory() {
        document.getElementById('historyLoader').style.display = 'flex';
        try {
            const response = await fetch(`${WEB_APP_URL}?action=getAllPaymentHistory`);
            const data = await response.json();
            rawHistoryData = data || [];
            renderHistoryTable(rawHistoryData);
        } catch (err) {
            showToast("হিস্ট্রি লোড করতে সমস্যা হয়েছে", true);
        } finally {
            document.getElementById('historyLoader').style.display = 'none';
        }
    }

    // --- পেমেন্ট আপডেট ফাংশন (POST রিকোয়েস্ট) ---
    async function submitPay(inv, due, isFull) {
        let amt = isFull ? due : parseFloat(document.getElementById(`in-${inv}`).value);
        if (!amt || amt <= 0 || amt > due) { 
            alert("সঠিক পরিমাণ লিখুন।"); 
            return; 
        }
        
        const wrapper = document.getElementById(`action-wrapper-${inv}`);
        const oldContent = wrapper.innerHTML;
        wrapper.innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span>';

        const payload = {
            action: "updateSalesPaidAmount",
            invNo: inv,
            amount: amt
        };

        try {
            // গিটহাব থেকে গুগল স্ক্রিপ্টে POST পাঠানো
            await fetch(WEB_APP_URL, {
                method: "POST",
                mode: "no-cors", // CORS হ্যান্ডলিং
                body: JSON.stringify(payload)
            });

            // no-cors মোডে রেসপন্স পড়া যায় না, তাই আমরা ধরে নিচ্ছি সফল হয়েছে এবং ডাটা রিফ্রেশ করছি
            showToast("পেমেন্ট রিকোয়েস্ট পাঠানো হয়েছে!");
            setTimeout(() => {
                fetchRecentSales(false);
                if (document.getElementById('historySection').style.display === 'block') fetchAllHistory();
            }, 2000); // সার্ভারে আপডেট হওয়ার জন্য সামান্য সময় দেয়া
            
        } catch (err) {
            alert("Error: " + err.message);
            wrapper.innerHTML = oldContent;
        }
    }

    // --- বাল্ক পেমেন্ট ফাংশন (গিটহাব ফ্রেন্ডলি) ---
    async function bulkPayFiltered() {
        const dueRows = currentFilteredData.filter(row => Number(row[12] || 0) > 0);
        if (dueRows.length === 0) return;

        if (!confirm(`আপনি কি ফিল্টারকৃত ${dueRows.length}টি ইনভয়েস পূর্ণ পেমেন্ট করতে চান?`)) return;

        const loader = document.getElementById('tableLoader');
        const loaderText = document.getElementById('loaderText');
        loader.style.display = 'flex';
        
        for (let i = 0; i < dueRows.length; i++) {
            const invNo = dueRows[i][0];
            const dueAmt = Number(dueRows[i][12] || 0);
            loaderText.innerText = `প্রসেসিং: ${i + 1}/${dueRows.length} (${invNo})`;

            await fetch(WEB_APP_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                    action: "updateSalesPaidAmount",
                    invNo: invNo,
                    amount: dueAmt
                })
            });
        }

        loader.style.display = 'none';
        showToast("বাল্ক পেমেন্ট রিকোয়েস্ট সম্পন্ন!");
        fetchRecentSales(true);
    }

    // --- ফিল্টার এবং রেন্ডার লজিক (আগের মতোই থাকবে) ---
    function applyMainFilters() {
        const searchVal = document.getElementById('globalSearch').value.toLowerCase().trim();
        const statusVal = document.getElementById('statusFilter').value;
        const startDate = document.getElementById('startDate').value; 
        const endDate = document.getElementById('endDate').value;    
        const bulkBtn = document.getElementById('bulkPayBtn');

        let filtered = rawSalesData.filter(row => {
            const matchesSearch = row.some(cell => String(cell).toLowerCase().includes(searchVal));
            const matchesStatus = !statusVal || row[10] === statusVal;
            let matchesDate = true;
            if (row[1] && (startDate || endDate)) {
                const rowDate = new Date(row[1]);
                rowDate.setHours(0,0,0,0);
                if (startDate) {
                    const start = new Date(startDate);
                    if (rowDate < start) matchesDate = false;
                }
                if (endDate) {
                    const end = new Date(endDate);
                    if (rowDate > end) matchesDate = false;
                }
            }
            return matchesSearch && matchesStatus && matchesDate;
        });

        currentFilteredData = filtered;
        const hasDueItems = currentFilteredData.some(row => Number(row[12] || 0) > 0);
        bulkBtn.style.display = (searchVal.length > 0 && hasDueItems) ? 'block' : 'none';

        renderSalesTable(currentFilteredData);
    }

    function renderSalesTable(data) {
        const tbody = document.getElementById('reportTableBody');
        let html = '';
        let tS = 0, tP = 0, tD = 0;

        data.forEach(row => {
            const [invNo, date, custCode, name, mobile, area, , , , total, status, paid, due] = row;
            const nTotal = Number(total || 0), nPaid = Number(paid || 0), nDue = Number(due || 0);
            tS += nTotal; tP += nPaid; tD += nDue;

            let stClass = status === 'FULL PAID' ? 'bg-success-subtle text-success border-success' : 
                         (status.includes('PART') ? 'bg-warning-subtle text-warning border-warning' : 'bg-danger-subtle text-danger border-danger');

            html += `<tr>
                <td class="fw-bold">${invNo}</td>
                <td class="small text-muted">${date}</td>
                <td class="text-secondary small fw-bold">${custCode || 'N/A'}</td>
                <td class="fw-bold text-dark">${name}</td>
                <td class="fw-bold text-primary">${mobile || '-'}</td>
                <td class="small text-muted">${area}</td>
                <td class="text-end">${nTotal.toLocaleString()}</td>
                <td class="text-end text-success">${nPaid.toLocaleString()}</td>
                <td class="text-end text-danger fw-bold">${nDue.toLocaleString()}</td>
                <td class="text-center"><span class="status-badge ${stClass}">${status}</span></td>
                <td class="text-center">
                    <div id="action-wrapper-${invNo}">
                        ${nDue > 0 ? `
                            <div class="d-flex gap-1 justify-content-center">
                                <select class="action-select" onchange="handleActionChange(this, '${invNo}', ${nDue})">
                                    <option value="">Select</option>
                                    <option value="FULL">Full</option>
                                    <option value="PART">Part</option>
                                </select>
                                <div id="part-input-area-${invNo}" class="d-none">
                                    <input type="number" id="in-${invNo}" class="paid-input" style="width:60px">
                                    <button class="btn btn-sm btn-success" onclick="submitPay('${invNo}', ${nDue}, false)">✓</button>
                                </div>
                            </div>
                        ` : '✅'}
                    </div>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html || '<tr><td colspan="11" class="text-center">No Data found</td></tr>';
        document.getElementById('summaryTotalSales').innerText = tS.toLocaleString();
        document.getElementById('summaryTotalPaid').innerText = tP.toLocaleString();
        document.getElementById('summaryTotalDue').innerText = tD.toLocaleString();
    }

    // পেমেন্ট হিস্ট্রি টেবিল রেন্ডার এবং অন্যান্য হেল্পার ফাংশনগুলো আগের মতোই কাজ করবে...
    // (সংক্ষিপ্ত করার জন্য এখানে সব পুনরায় লেখা হয়নি, আপনার আগের কোডের renderHistoryTable লজিক ব্যবহার করুন)

    function toggleHistorySection() {
        const historySection = document.getElementById('historySection');
        const isHistoryVisible = historySection.style.display === 'block';
        
        document.getElementById('historySection').style.display = isHistoryVisible ? 'none' : 'block';
        document.getElementById('mainSummary').style.display = isHistoryVisible ? 'flex' : 'none';
        document.getElementById('mainTableContainer').style.display = isHistoryVisible ? 'block' : 'none';
        document.getElementById('filterSection').style.display = isHistoryVisible ? 'block' : 'none';
        
        const btn = document.getElementById('historyBtn');
        btn.innerHTML = isHistoryVisible ? '<i class="fas fa-history"></i> History' : '<i class="fas fa-arrow-left"></i> Back';
        
        if (!isHistoryVisible) fetchAllHistory();
    }

    window.onload = () => fetchRecentSales(true);
</script>
</body>
</html>