<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="report.png">
    <title>Report Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root{--report-blue:#3498db;--header-bg:#2c3e50;--history-bg:#ffffff}
        body{background-color:#f4f7f6;font-family:'Segoe UI',Tahoma,sans-serif}
        .sticky-top-container{position:sticky;top:0;z-index:1050;background-color:#f4f7f6;padding:10px 0}
        .table-container,.history-container{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.05);position:relative;overflow:hidden;margin-bottom:20px}
        .history-container{display:none;border:2px solid var(--report-blue);margin-top:10px}
        .table thead th{background-color:var(--header-bg)!important;color:#fff!important;font-size:.7rem;text-transform:uppercase;white-space:nowrap;vertical-align: middle;}
        .status-badge{font-size:.65rem;padding:4px 8px;border-radius:20px;font-weight:600;border:1px solid}
        .action-select{font-size:.7rem;padding:3px;border-radius:4px;border:1px solid #ddd}
        .paid-input{width:70px;font-size:.7rem;border:1px solid var(--report-blue);border-radius:4px;padding:2px}
        #historyLoader,#tableLoader{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.7);display:none;justify-content:center;align-items:center;z-index:1100}
        .toast-msg{position:fixed;bottom:20px;right:20px;z-index:2000;display:none;padding:12px 24px;border-radius:8px;color:#fff;box-shadow:0 4px 15px rgba(0,0,0,.15);font-weight:600}
        .filter-section{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
        .history-summary-footer{background: #2c3e50; color: white; padding: 12px; font-size: 0.75rem;}
        .small-text { font-size: 0.7rem; }
        .summary-label { font-size: 0.6rem; color: #bdc3c7; text-transform: uppercase; margin-bottom: 2px; }
        .summary-value { font-size: 0.9rem; font-weight: bold; }
        .card-stat { transition: transform 0.2s; border: none !important; }
        .table td { font-size: 0.75rem; white-space: nowrap; }
    </style>
</head>
<body>

<div id="toast" class="toast-msg"></div>

<div class="container-fluid px-3">
    <!-- Header & Main Summary -->
    <div class="sticky-top-container">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h4 class="fw-bold m-0 text-dark">REPORT MANAGEMENT SYSTEM</h4>
                <p class="text-muted small mb-0">SALES & PAYMENT MONITORING</p>
            </div>
            <div class="d-flex gap-2">
                <button id="historyBtn" class="btn btn-primary btn-sm rounded-pill px-3" onclick="toggleHistorySection()">
                    <i class="fas fa-history me-1"></i> Payment History
                </button>
                <button class="btn btn-dark btn-sm rounded-pill px-4" onclick="fetchRecentSales(true)">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>

        <div class="row g-2 mb-3 text-center" id="mainSummary">
            <div class="col-md-2">
                <div class="card p-2 shadow-sm card-stat bg-primary-subtle border-primary">
                    <h6 class="text-muted small mb-1" style="font-size: 0.6rem;">TODAY SALE</h6>
                    <h5 id="summaryTodaySale" class="fw-bold m-0 text-primary" style="font-size: 1rem;">0</h5>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card p-2 shadow-sm card-stat bg-success-subtle border-success">
                    <h6 class="text-muted small mb-1" style="font-size: 0.6rem;">TODAY COLLECTION</h6>
                    <h5 id="summaryTodayCollection" class="fw-bold m-0 text-success" style="font-size: 1rem;">0</h5>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card p-2 shadow-sm card-stat">
                    <h6 class="text-muted small mb-1" style="font-size: 0.6rem;">TOTAL SALE</h6>
                    <h5 id="summaryTotalSales" class="fw-bold m-0 text-dark" style="font-size: 1rem;">0</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-2 shadow-sm card-stat">
                    <h6 class="text-muted small mb-1" style="font-size: 0.6rem;">TOTAL COLLECTION</h6>
                    <h5 id="summaryTotalPaid" class="fw-bold m-0 text-success" style="font-size: 1rem;">0</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-2 shadow-sm card-stat">
                    <h6 class="text-muted small mb-1" style="font-size: 0.6rem;">TOTAL DUE</h6>
                    <h5 id="summaryTotalDue" class="fw-bold m-0 text-danger" style="font-size: 1rem;">0</h5>
                </div>
            </div>
        </div>

        <div id="mainFilterContainer">
            <div id="filterSection" class="filter-section mb-3">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="globalSearch" class="form-control" placeholder="Search Sales by Name, Invoice, Mobile..." onkeyup="applyMainFilters()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select id="statusFilter" class="form-select form-select-sm" onchange="applyMainFilters()">
                            <option value="">All Status</option>
                            <option value="UNPAID">Unpaid</option>
                            <option value="PART PAID">Part Paid</option>
                            <option value="FULL PAID">Full Paid</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white small" style="font-size: 0.65rem;">Filter Date</span>
                            <input type="date" id="startDate" class="form-control form-control-sm" onchange="applyMainFilters()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-sm btn-outline-danger w-100" onclick="resetMainFilters()">Reset All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Table -->
    <div id="mainTableContainer" class="table-container border">
        <div id="tableLoader"><div class="spinner-border text-primary"></div></div>
        <div class="table-responsive" style="max-height: 65vh;">
            <table class="table table-hover align-middle mb-0">
                <thead class="sticky-top">
                    <tr>
                        <th>SL</th>
                        <th>Date</th>
                        <th>Inv No</th>
                        <th>Cust. Code</th>
                        <th>Customer Name</th>
                        <th>Mobile No</th>
                        <th>Area</th>
                        <th>Address</th>
                        <th class="text-end">Total</th>
                        <th class="text-end">Paid</th>
                        <th class="text-end">Due</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <tr><td colspan="13" class="text-center py-5">Loading Data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- History Section -->
    <div id="historySection" class="history-container">
        <div class="bg-dark text-white p-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="small ms-2 fw-bold"><i class="fas fa-history me-2"></i>Payment History Details</span>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success py-0 px-2" onclick="exportHistoryCSV()"><i class="fas fa-file-csv me-1"></i>CSV</button>
                <button class="btn btn-sm btn-danger py-0 px-2" onclick="exportHistoryPDF()"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                <button class="btn btn-sm btn-outline-light py-0" onclick="toggleHistorySection()">Close</button>
            </div>
        </div>

        <div class="p-2 border-bottom bg-light">
            <div class="row g-2">
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                        <input type="text" id="historySearch" class="form-control" placeholder="Search history..." onkeyup="filterHistoryData()">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white">Pay Date</span>
                        <input type="date" id="historyDateFilter" class="form-control" onchange="filterHistoryData()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="historyStatusFilter" class="form-select form-select-sm" onchange="filterHistoryData()">
                        <option value="">All Types</option>
                        <option value="FULL PAID">FULL PAID</option>
                        <option value="PART PAID">PART PAID</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetHistoryFilters()">Clear Filter</button>
                </div>
            </div>
        </div>

        <div class="table-responsive" style="max-height: 400px; min-height: 100px;">
            <div id="historyLoader"><div class="spinner-border text-primary"></div></div>
            <table class="table table-sm table-hover mb-0" id="historyTable" style="min-width: 1200px;">
                <thead class="sticky-top">
                    <tr>
                        <th>SL</th>
                        <th>Payment Date</th>
                        <th>Invoice No</th>
                        <th>Invoice Date</th>
                        <th>Customer Name</th>
                        <th class="text-end">Paid Amount</th>
                        <th class="text-center">Status</th>
                        <th>Operator</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <!-- SUMMARY FOOTER -->
        <div id="historySummaryFooter" class="history-summary-footer border-top">
            <div class="row text-center g-2 align-items-center">
                <div class="col-md-3 border-end border-secondary">
                    <div class="summary-label">Total Collection</div>
                    <div class="d-flex justify-content-center align-items-baseline gap-2">
                        <span id="histTotalCount" class="badge bg-primary">0</span>
                        <span id="histTotalAmt" class="summary-value text-white">0</span>
                    </div>
                </div>
                <div class="col-md-3 border-end border-secondary">
                    <div class="summary-label text-warning">Part Paid</div>
                    <div class="d-flex justify-content-center align-items-baseline gap-2">
                        <span id="histPartCount" class="badge bg-warning text-dark">0</span>
                        <span id="histPartAmt" class="summary-value text-warning">0</span>
                    </div>
                </div>
                <div class="col-md-3 border-end border-secondary">
                    <div class="summary-label text-success">Full Paid</div>
                    <div class="d-flex justify-content-center align-items-baseline gap-2">
                        <span id="histFullCount" class="badge bg-success">0</span>
                        <span id="histFullAmt" class="summary-value text-success">0</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-label text-info">Filtered Date Total</div>
                    <div id="histTodayTotal" class="summary-value text-info">0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkDCX5zax-NuoSKRSxJIjL9Rx4MbtVxvm5QlrOEIxrTR-s3sVuRHJy_ISNIm3ehDYs/exec";
    const urlParams = new URLSearchParams(window.location.search);
    const currentUserName = urlParams.get('name') || "Unknown";
    const currentUserId = urlParams.get('id') || "Unknown";

    let rawSalesData = [];
    let rawHistoryData = [];
    let currentFilteredHistory = [];
    
    // Global Summary Stats for Export
    let sumStats = { totalCount:0, totalAmt:0, partCount:0, partAmt:0, fullCount:0, fullAmt:0 };

    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.backgroundColor = isError ? '#e74c3c' : '#27ae60';
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 3000);
    }

    function normalizeToISO(dateVal) {
        if (!dateVal || dateVal === "-" || dateVal === "undefined") return "";
        let dStr = String(dateVal).trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(dStr)) return dStr;
        const separator = dStr.includes('.') ? '.' : (dStr.includes('-') ? '-' : null);
        if (separator) {
            const parts = dStr.split(separator);
            if (parts.length === 3) {
                let d, m, y;
                if (parts[2].length === 4) { d = parts[0].padStart(2,'0'); m = parts[1].padStart(2,'0'); y = parts[2]; }
                else if (parts[0].length === 4) { y = parts[0]; m = parts[1].padStart(2,'0'); d = parts[2].padStart(2,'0'); }
                if (y) return `${y}-${m}-${d}`;
            }
        }
        try {
            const d = new Date(dateVal);
            if (!isNaN(d.getTime())) return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        } catch(e) {}
        return "";
    }

    async function fetchRecentSales(showLoader = false) {
        if(showLoader) document.getElementById('tableLoader').style.display = 'flex';
        try {
            const resp = await fetch(`${WEB_APP_URL}?action=getSalesMasterData`);
            const data = await resp.json();
            rawSalesData = (data && data.length > 1) ? data.slice(1) : [];
            applyMainFilters();
        } catch (e) { showToast("Connection Error!", true); }
        finally { document.getElementById('tableLoader').style.display = 'none'; }
    }

    function applyMainFilters() {
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('startDate').value; 
        const filtered = rawSalesData.filter(row => {
            const rowDate = normalizeToISO(row[1]); 
            return row.some(c => String(c).toLowerCase().includes(search)) && (!status || row[10] === status) && (!dateFilter || rowDate === dateFilter);
        });
        renderSalesTable(filtered);
    }

    function renderSalesTable(data) {
        const tbody = document.getElementById('reportTableBody');
        let html = '', tS = 0, tP = 0, tD = 0, todaySale = 0;
        const now = new Date();
        const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

        data.forEach((row, index) => {
            const total = Number(row[9] || 0), paid = Number(row[11] || 0), due = Number(row[12] || 0), status = row[10];
            tS += total; tP += paid; tD += due;
            if(normalizeToISO(row[1]) === todayStr) todaySale += total;
            let badge = status === 'FULL PAID' ? 'bg-success-subtle text-success' : (status.includes('PART') ? 'bg-warning-subtle text-warning' : 'bg-danger-subtle text-danger');
            html += `<tr><td>${index+1}</td><td>${row[1]}</td><td class="fw-bold">${row[0]}</td><td>${row[2]}</td><td class="fw-bold">${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td><td class="small-text">${row[6]}</td><td class="text-end fw-bold">${total.toLocaleString()}</td><td class="text-end text-success">${paid.toLocaleString()}</td><td class="text-end text-danger fw-bold">${due.toLocaleString()}</td><td class="text-center"><span class="status-badge ${badge} border">${status}</span></td><td class="text-center"><div id="action-wrapper-${row[0]}">${due > 0 ? `<select class="action-select" onchange="handleAction('${row[0]}', ${due}, this)"><option value="">Action</option><option value="FULL">Full</option><option value="PART">Part</option></select><div id="part-${row[0]}" class="d-none mt-1"><input type="number" id="in-${row[0]}" class="paid-input"><button class="btn btn-sm btn-success p-0 px-1" onclick="processPay('${row[0]}', ${due}, false)">OK</button></div>` : 'âœ…'}</div></td></tr>`;
        });
        tbody.innerHTML = html || '<tr><td colspan="13" class="text-center">No Data Found</td></tr>';
        document.getElementById('summaryTotalSales').innerText = tS.toLocaleString();
        document.getElementById('summaryTotalPaid').innerText = tP.toLocaleString();
        document.getElementById('summaryTotalDue').innerText = tD.toLocaleString();
        document.getElementById('summaryTodaySale').innerText = todaySale.toLocaleString();
        updateTodayCollectionFromHistory(todayStr);
    }

    async function updateTodayCollectionFromHistory(todayISO) {
        try {
            const r = await fetch(`${WEB_APP_URL}?action=getAllPaymentHistory`);
            const data = await r.json();
            if (data && data.length > 1) {
                let todayColl = 0;
                data.slice(1).forEach(row => { if (normalizeToISO(row[0]) === todayISO) todayColl += Number(row[8] || 0); });
                document.getElementById('summaryTodayCollection').innerText = todayColl.toLocaleString();
            }
        } catch (e) {}
    }

    function handleAction(inv, due, el) {
        const p = document.getElementById(`part-${inv}`);
        if(el.value === 'FULL') { if(confirm(`Pay full ${due}?`)) processPay(inv, due, true); else el.value = ''; }
        else if(el.value === 'PART') p.classList.remove('d-none');
        else p.classList.add('d-none');
    }

    async function processPay(inv, due, isFull) {
        let amt = isFull ? due : parseFloat(document.getElementById(`in-${inv}`).value);
        if(!amt || amt <= 0 || amt > due) return alert('Invalid Amount');
        try {
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "updateSalesPaidAmount", invNo: inv, amount: amt, operatorName: currentUserName, operatorId: currentUserId }) });
            showToast("Success"); fetchRecentSales(false);
        } catch (e) { showToast("Failed", true); }
    }

    function toggleHistorySection() {
        const hs = document.getElementById('historySection'), mt = document.getElementById('mainTableContainer'), mf = document.getElementById('mainFilterContainer');
        const isHidden = hs.style.display === 'none' || hs.style.display === '';
        hs.style.display = isHidden ? 'block' : 'none'; mt.style.display = isHidden ? 'none' : 'block'; mf.style.display = isHidden ? 'none' : 'block';
        if(isHidden) fetchHistory();
    }

    async function fetchHistory() {
        document.getElementById('historyLoader').style.display = 'flex';
        try {
            const r = await fetch(`${WEB_APP_URL}?action=getAllPaymentHistory`);
            const data = await r.json();
            rawHistoryData = data.slice(1); 
            filterHistoryData();
        } finally { document.getElementById('historyLoader').style.display = 'none'; }
    }

    function filterHistoryData() {
        const search = document.getElementById('historySearch').value.toLowerCase();
        const dateFilter = document.getElementById('historyDateFilter').value;
        const statusFilter = document.getElementById('historyStatusFilter').value;
        currentFilteredHistory = rawHistoryData.filter(row => {
            const payDate = normalizeToISO(row[0]);
            return row.some(c => String(c).toLowerCase().includes(search)) && (!dateFilter || payDate === dateFilter) && (!statusFilter || String(row[10]).toUpperCase() === statusFilter);
        });
        renderHistoryTable(currentFilteredHistory);
    }

    function renderHistoryTable(data) {
        let html = '', totalAmt = 0, fullAmt = 0, partAmt = 0, filteredDateColl = 0;
        let totalCount = 0, fullCount = 0, partCount = 0;
        const filterDate = document.getElementById('historyDateFilter').value;

        data.forEach((row, i) => {
            const amt = Number(row[8] || 0);
            const status = String(row[10]).toUpperCase();
            const payDateISO = normalizeToISO(row[0]);
            totalAmt += amt; totalCount++;
            if(status === 'FULL PAID') { fullAmt += amt; fullCount++; }
            else if(status === 'PART PAID') { partAmt += amt; partCount++; }
            if(filterDate && payDateISO === filterDate) filteredDateColl += amt;
            html += `<tr><td>${i+1}</td><td>${row[0]}</td><td class="fw-bold">${row[2]}</td><td>${row[3]}</td><td>${row[5]}</td><td class="text-end fw-bold text-success">${amt.toLocaleString()}</td><td class="text-center">${row[10]}</td><td>${row[11]}</td></tr>`;
        });
        
        // Sync stats for export
        sumStats = { totalCount, totalAmt, partCount, partAmt, fullCount, fullAmt };

        document.getElementById('historyTableBody').innerHTML = html || '<tr><td colspan="8" class="text-center">No History Records</td></tr>';
        document.getElementById('histTotalAmt').innerText = totalAmt.toLocaleString();
        document.getElementById('histTotalCount').innerText = totalCount;
        document.getElementById('histPartAmt').innerText = partAmt.toLocaleString();
        document.getElementById('histPartCount').innerText = partCount;
        document.getElementById('histFullAmt').innerText = fullAmt.toLocaleString();
        document.getElementById('histFullCount').innerText = fullCount;
        document.getElementById('histTodayTotal').innerText = filterDate ? filteredDateColl.toLocaleString() : "Set Date";
    }

    function resetHistoryFilters() {
        document.getElementById('historySearch').value = ''; document.getElementById('historyDateFilter').value = ''; document.getElementById('historyStatusFilter').value = '';
        filterHistoryData();
    }

    function resetMainFilters() {
        document.getElementById('globalSearch').value = ''; document.getElementById('statusFilter').value = ''; document.getElementById('startDate').value = '';
        applyMainFilters();
    }

    function exportHistoryCSV() {
        if(currentFilteredHistory.length === 0) return alert("No data to export");
        let csv = "SL,Payment Date,Invoice No,Invoice Date,Customer Name,Paid Amount,Status,Operator\n";
        currentFilteredHistory.forEach((row, i) => {
            csv += `${i+1},${row[0]},${row[2]},${row[3]},${row[5]},${row[8]},${row[10]},${row[11]}\n`;
        });
        
        csv += "\n--- Summary ---\n";
        csv += `Total Collection,${sumStats.totalCount},${sumStats.totalAmt}\n`;
        csv += `Part Paid,${sumStats.partCount},${sumStats.partAmt}\n`;
        csv += `Full Paid,${sumStats.fullCount},${sumStats.fullAmt}\n`;

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `History_Report_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }

    function exportHistoryPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Header
        doc.setFontSize(16);
        doc.setTextColor(44, 62, 80);
        doc.text("Payment History Report", 14, 15);
        
        doc.setFontSize(9);
        doc.setTextColor(100);
        doc.text(`Generated by: ${currentUserName} | ID: ${currentUserId}`, 14, 21);
        doc.text(`Date: ${new Date().toLocaleString()}`, 14, 25);
        
        // Data Transformation (Only selected columns)
        const tableData = currentFilteredHistory.map((row, i) => [
            i+1, row[0], row[2], row[3], row[5], row[8].toLocaleString()
        ]);

        // Add Grand Total Row to the body
        tableData.push([
            { content: 'Grand Total', colSpan: 5, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } },
            { content: sumStats.totalAmt.toLocaleString(), styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } }
        ]);

        // Main Table
        doc.autoTable({
            head: [['SL', 'Pay Date', 'Inv No', 'Inv Date', 'Customer', 'Amount']],
            body: tableData,
            startY: 32,
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80], fontSize: 8, halign: 'center' },
            bodyStyles: { fontSize: 8 },
            columnStyles: { 
                0: { halign: 'center', cellWidth: 10 },
                1: { cellWidth: 25 },
                2: { fontStyle: 'bold', cellWidth: 25 },
                5: { halign: 'right', fontStyle: 'bold' } 
            },
            margin: { bottom: 30 }
        });

        // Summary Table (Footer)
        const finalY = doc.lastAutoTable.finalY + 10;
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(44, 62, 80);
        doc.text("COLLECTION SUMMARY", 14, finalY);

        const summaryRows = [
            ["Collection Status", "Count", "Total Amount"],
            ["Full Paid", sumStats.fullCount.toString(), sumStats.fullAmt.toLocaleString()],
            ["Part Paid", sumStats.partCount.toString(), sumStats.partAmt.toLocaleString()],
            ["Total Collection", sumStats.totalCount.toString(), sumStats.totalAmt.toLocaleString()]
        ];

        doc.autoTable({
            body: summaryRows,
            startY: finalY + 3,
            theme: 'plain',
            styles: { fontSize: 9, cellPadding: 2 },
            columnStyles: { 
                0: { fontStyle: 'bold', cellWidth: 40 },
                1: { halign: 'center', cellWidth: 20 },
                2: { halign: 'right', fontStyle: 'bold', cellWidth: 40 }
            },
            didDrawCell: (data) => {
                // Header underline
                if (data.row.index === 0) {
                    doc.setDrawColor(44, 62, 80);
                    doc.setLineWidth(0.5);
                    doc.line(data.cell.x, data.cell.y + data.cell.height, data.cell.x + data.cell.width, data.cell.y + data.cell.height);
                }
                // Final Total line
                if (data.row.index === 3) {
                    doc.setDrawColor(44, 62, 80);
                    doc.setLineWidth(0.3);
                    doc.line(data.cell.x, data.cell.y, data.cell.x + data.cell.width, data.cell.y);
                }
            }
        });

        doc.save(`Payment_History_${new Date().getTime()}.pdf`);
    }

    window.onload = () => fetchRecentSales(true);
</script>
</body>
</html>
