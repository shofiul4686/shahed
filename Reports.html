<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="report.png">
    <title>Business Report System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --report-blue: #3498db; --header-bg: #2c3e50; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, sans-serif; }
        .sticky-top-container { position: sticky; top: 0; z-index: 1050; background-color: #f4f7f6; padding: 10px 0; }
        .table-container, .history-container { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,.05); position: relative; overflow: hidden; margin-bottom: 20px; }
        .history-container { display: none; border: 2px solid var(--report-blue); margin-top: 10px; }
        .table thead th { background-color: var(--header-bg)!important; color: #fff!important; font-size: .75rem; text-transform: uppercase; white-space: nowrap; }
        .status-badge { font-size: .65rem; padding: 4px 8px; border-radius: 20px; font-weight: 600; border: 1px solid; }
        #tableLoader, #historyLoader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .toast-msg { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: none; padding: 12px 24px; border-radius: 8px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    </style>
</head>
<body>

<div id="toast" class="toast-msg"></div>

<div class="container-fluid px-3">
    <!-- Header -->
    <div class="sticky-top-container">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h4 class="fw-bold m-0 text-dark">Business Report System</h4>
                <p class="text-muted small mb-0">ইনভয়েস এবং পেমেন্ট ট্র্যাকিং</p>
            </div>
            <div class="d-flex gap-2">
                <button id="historyBtn" class="btn btn-primary btn-sm rounded-pill px-3" onclick="toggleHistorySection()">
                    <i class="fas fa-history me-1"></i> Payment History
                </button>
                <button class="btn btn-dark btn-sm rounded-pill px-4" onclick="fetchRecentSales(true)">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Global Filter Section -->
        <div id="filterSection" class="filter-section mb-3">
            <div class="card p-3 shadow-sm border-0 bg-white">
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" id="globalSearch" class="form-control form-control-sm" placeholder="Search Invoice, Name, Mobile..." onkeyup="applyMainFilters()">
                    </div>
                    <div class="col-md-2">
                        <select id="statusFilter" class="form-select form-select-sm" onchange="applyMainFilters()">
                            <option value="">All Status</option>
                            <option value="UNPAID">Unpaid</option>
                            <option value="PART PAID">Part Paid</option>
                            <option value="FULL PAID">Full Paid</option>
                        </select>
                    </div>
                    <div class="col-md-2"><input type="date" id="startDate" class="form-control form-control-sm" onchange="applyMainFilters()"></div>
                    <div class="col-md-2"><input type="date" id="endDate" class="form-control form-control-sm" onchange="applyMainFilters()"></div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-2 mb-3 text-center" id="mainSummary">
            <div class="col-md-4"><div class="card p-2 border-0 shadow-sm text-primary"><h6>Total Sales</h6><h5 id="sumSales">0</h5></div></div>
            <div class="col-md-4"><div class="card p-2 border-0 shadow-sm text-success"><h6>Total Paid</h6><h5 id="sumPaid">0</h5></div></div>
            <div class="col-md-4"><div class="card p-2 border-0 shadow-sm text-danger"><h6>Total Due</h6><h5 id="sumDue">0</h5></div></div>
        </div>
    </div>

    <!-- History Section -->
    <div id="historySection" class="history-container">
        <div class="bg-dark text-white p-2 d-flex justify-content-between align-items-center">
            <span class="fw-bold small ms-2">Payment History</span>
            <button class="btn btn-sm btn-danger py-0" onclick="toggleHistorySection()">Close</button>
        </div>
        <div class="table-responsive" style="max-height: 400px;">
            <div id="historyLoader"><div class="spinner-border text-primary"></div></div>
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr><th>Date</th><th>Inv No</th><th>Customer</th><th class="text-end">Paid</th><th class="text-end">Due Left</th><th>Status</th></tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Main Table -->
    <div id="mainTableContainer" class="table-container">
        <div id="tableLoader"><div class="spinner-border text-primary"></div></div>
        <div class="table-responsive" style="max-height: 60vh;">
            <table class="table table-hover align-middle mb-0">
                <thead class="sticky-top">
                    <tr><th>Inv No</th><th>Date</th><th>Customer</th><th>Mobile</th><th class="text-end">Total</th><th class="text-end">Paid</th><th class="text-end">Due</th><th class="text-center">Status</th></tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkDCX5zax-NuoSKRSxJIjL9Rx4MbtVxvm5QlrOEIxrTR-s3sVuRHJy_ISNIm3ehDYs/exec";
    let rawSalesData = [];

    async function fetchRecentSales(showLoader = false) {
        if (showLoader) document.getElementById('tableLoader').style.display = 'flex';
        try {
            const response = await fetch(`${WEB_APP_URL}?action=getSalesMasterData`);
            const data = await response.json();
            rawSalesData = data.slice(1);
            applyMainFilters();
        } catch (err) {
            console.error("Fetch error:", err);
        } finally {
            document.getElementById('tableLoader').style.display = 'none';
        }
    }

    function applyMainFilters() {
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        const filtered = rawSalesData.filter(row => {
            const matchesSearch = row.slice(0, 6).some(c => String(c).toLowerCase().includes(search));
            const matchesStatus = !status || row[10] === status;
            let matchesDate = true;
            if (start || end) {
                const d = new Date(row[1]);
                if (start && d < new Date(start)) matchesDate = false;
                if (end && d > new Date(end)) matchesDate = false;
            }
            return matchesSearch && matchesStatus && matchesDate;
        });
        renderTable(filtered);
    }

    function renderTable(data) {
        const tbody = document.getElementById('reportTableBody');
        let html = '', tS = 0, tP = 0, tD = 0;
        data.forEach(row => {
            tS += Number(row[9]); tP += Number(row[11]); tD += Number(row[12]);
            const badge = row[10] === 'FULL PAID' ? 'bg-success-subtle text-success' : (row[10] === 'UNPAID' ? 'bg-danger-subtle text-danger' : 'bg-warning-subtle text-warning');
            html += `<tr>
                <td><b>${row[0]}</b></td><td>${row[1]}</td><td>${row[3]}</td><td>${row[4]}</td>
                <td class="text-end">${Number(row[9]).toLocaleString()}</td>
                <td class="text-end text-success">${Number(row[11]).toLocaleString()}</td>
                <td class="text-end text-danger fw-bold">${Number(row[12]).toLocaleString()}</td>
                <td class="text-center"><span class="status-badge ${badge}">${row[10]}</span></td>
            </tr>`;
        });
        tbody.innerHTML = html;
        document.getElementById('sumSales').innerText = tS.toLocaleString();
        document.getElementById('sumPaid').innerText = tP.toLocaleString();
        document.getElementById('sumDue').innerText = tD.toLocaleString();
    }

    async function toggleHistorySection() {
        const sect = document.getElementById('historySection');
        const isVisible = sect.style.display === 'block';
        sect.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) {
            document.getElementById('historyLoader').style.display = 'flex';
            const res = await fetch(`${WEB_APP_URL}?action=getAllPaymentHistory`);
            const data = await res.json();
            document.getElementById('historyTableBody').innerHTML = data.map(r => `
                <tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[4]}</td><td class="text-end">${r[7]}</td><td class="text-end">${r[8]}</td><td>${r[9]}</td></tr>
            `).join('');
            document.getElementById('historyLoader').style.display = 'none';
        }
    }

    window.onload = () => fetchRecentSales(true);
</script>
</body>
</html>
